package musicPlayer;

import javax.sound.sampled.*;
import javax.swing.*;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import java.awt.*;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;

public class Main {

    private static Clip clip;
    private static AudioInputStream audioStream;
    private static int currentSongIndex = 0;
    private static final String[] playlist = {
            "src/musicPlayer/F16 - The Grey Room _ Golden Palms.wav",
            "src/musicPlayer/make the visible invisible - Alge.wav"
    };

    private static JLabel name;
    private static JSlider progress;
    private static Timer timer;

    public static void main(String[] args) {
        // --- UI setup ---
        JFrame frame = new JFrame("Music Player");
        frame.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        frame.setSize(520, 220);
        frame.setLayout(new FlowLayout(FlowLayout.LEFT, 10, 10));

        name = new JLabel("Now Playing: " + new File(playlist[currentSongIndex]).getName());
        name.setPreferredSize(new Dimension(480, 20));

        JButton playButton = new JButton("Play");
        JButton stopButton = new JButton("Stop");
        JButton resetButton = new JButton("Reset");
        JButton nextButton = new JButton("Next");
        JButton prevButton = new JButton("Previous");
        JButton quitButton = new JButton("Quit");

        // Progress slider (0..1000 = 0..100%)
        progress = new JSlider(0, 1000, 0);
        progress.setPreferredSize(new Dimension(480, 24));
        progress.setToolTipText("Drag to seek");

        // Add components
        frame.add(name);
        frame.add(progress);
        frame.add(playButton);
        frame.add(stopButton);
        frame.add(resetButton);
        frame.add(prevButton);
        frame.add(nextButton);
        frame.add(quitButton);

        // Ensure we clean up even if the window X is clicked
        frame.addWindowListener(new WindowAdapter() {
            @Override
            public void windowClosing(WindowEvent e) {
                shutdown();
            }
        });

        // --- Audio init + bindings ---
        initializeAudio();
        bindProgress();

        // --- Button actions ---
        playButton.addActionListener(e -> {
            if (clip != null) clip.start();
        });

        stopButton.addActionListener(e -> {
            if (clip != null) clip.stop();
        });

        resetButton.addActionListener(e -> {
            if (clip != null) {
                clip.setMicrosecondPosition(0);
                progress.setValue(0);
            }
        });

        nextButton.addActionListener(e -> {
            currentSongIndex = (currentSongIndex + 1) % playlist.length;
            switchSong();
        });

        prevButton.addActionListener(e -> {
            currentSongIndex = (currentSongIndex - 1 + playlist.length) % playlist.length;
            switchSong();
        });

        quitButton.addActionListener(e -> {
            shutdown();
            System.exit(0);
        });

        frame.setVisible(true);
    }

    // Open the initial track
    private static void initializeAudio() {
        try {
            File file = new File(playlist[currentSongIndex]);
            audioStream = AudioSystem.getAudioInputStream(file);
            clip = AudioSystem.getClip();
            clip.open(audioStream);
        } catch (FileNotFoundException e) {
            System.out.println("Could not find file");
        } catch (LineUnavailableException e) {
            System.out.println("Cannot access audio source");
        } catch (UnsupportedAudioFileException e) {
            System.out.println("Audio file not supported");
        } catch (IOException e) {
            System.out.println("Error loading audio file");
        }
    }

    // Timer + slider seeking
    private static void bindProgress() {
        // Update slider ~10x per second
        timer = new Timer(100, e -> {
            if (clip == null) return;

            // Don't fight the user while they're dragging
            if (progress.getValueIsAdjusting()) return;

            long length = clip.getMicrosecondLength();
            long position = clip.getMicrosecondPosition();

            if (length > 0) {
                int value = (int) Math.min(1000L, (position * 1000L) / length);
                progress.setValue(value);
            } else {
                progress.setValue(0);
            }
        });
        timer.start();

        // Seek on release
        progress.addChangeListener(new ChangeListener() {
            @Override
            public void stateChanged(ChangeEvent e) {
                if (clip == null || progress.getValueIsAdjusting()) return;

                long length = clip.getMicrosecondLength();
                long target = (length * progress.getValue()) / 1000L;

                boolean wasRunning = clip.isRunning();
                clip.stop();
                clip.setMicrosecondPosition(target);
                if (wasRunning) clip.start();
            }
        });
    }

    // Load the next/prev track properly
    private static void switchSong() {
        try {
            // Stop and close previous clip
            if (clip != null) {
                try { clip.stop(); } catch (Exception ignored) {}
                try { clip.close(); } catch (Exception ignored) {}
            }
            if (audioStream != null) {
                try { audioStream.close(); } catch (IOException ignored) {}
            }

            // Open the new one
            File file = new File(playlist[currentSongIndex]);
            audioStream = AudioSystem.getAudioInputStream(file);
            clip = AudioSystem.getClip();
            clip.open(audioStream);

            name.setText("Now Playing: " + file.getName());
            progress.setValue(0);
            clip.start();
        } catch (UnsupportedAudioFileException | IOException | LineUnavailableException e) {
            System.out.println("Error loading new audio: " + e.getMessage());
        }
    }

    // Centralized cleanup
    private static void shutdown() {
        if (timer != null) {
            try { timer.stop(); } catch (Exception ignored) {}
        }
        if (clip != null) {
            try { clip.stop(); } catch (Exception ignored) {}
            try { clip.close(); } catch (Exception ignored) {}
        }
        if (audioStream != null) {
            try { audioStream.close(); } catch (IOException ignored) {}
        }
    }
}